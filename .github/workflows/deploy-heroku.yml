name: Deploy to Heroku

on:
    push:
        branches:
            - develop # Trigger on push to develop branch

jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # Fetch all history for unshallow clone

            - name: Setup Git
              run: |
                  git config --global user.name "GitHub Actions"
                  git config --global user.email "actions@github.com"

            - name: Install Heroku CLI
              run: |
                  curl https://cli-assets.heroku.com/install.sh | sh

            - name: Authenticate with Heroku and Deploy
              env:
                  HEROKU_API_KEY: ${{secrets.HEROKU_API_KEY}}
              run: |
                  # Create a custom credential helper script that uses the API key
                  cat > /tmp/git-credential-helper.sh << EOF
                  #!/bin/bash
                  echo "username=1bis.solutions.tech@gmail.com"
                  echo "password=$HEROKU_API_KEY"
                  EOF
                  chmod +x /tmp/git-credential-helper.sh

                  # Configure git to use the custom credential helper
                  git config --global credential.helper "/tmp/git-credential-helper.sh"

                  # Unshallow the repository (Heroku requires full clone)
                  git fetch --unshallow || git fetch --all

                  # Add Heroku remote manually
                  git remote add heroku https://git.heroku.com/epp-api-dev.git || git remote set-url heroku https://git.heroku.com/epp-api-dev.git

                  # Push to Heroku main branch (same command we used manually)
                  git push heroku HEAD:main --force
